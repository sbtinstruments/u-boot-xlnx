PROCESSORS=$(shell grep -c ^processor /proc/cpuinfo)
CFLAGS="-O2 -mtune=cortex-a9 -mfpu=neon -mfloat-abi=hard"
CROSS_COMPILE?=arm-linux-gnueabihf-
UBOOT_MAKE=CROSS_COMPILE=$(CROSS_COMPILE) $(MAKE) -j $(PROCESSORS) \
	ARCH=arm CFLAGS=$(CFLAGS)



.PHONY: all
all: u-boot.elf



###############################################################################
### U-boot ELF file
###############################################################################
u-boot.elf: set-version \
            .config \
            common/* \
            configs/* \
            include/* \
            arch/arm/dts/*.dts \
            arch/arm/dts/*.dtsi
	$(UBOOT_MAKE)



###############################################################################
### Defconfig
###############################################################################
.config: TARGET_defined configs/zynq_green_mango_$(TARGET)_defconfig
	$(UBOOT_MAKE) zynq_green_mango_$(TARGET)_defconfig

.PHONY: TARGET_defined
TARGET_defined:
ifndef TARGET
	$(error "The 'TARGET' environment variable is not set. Set it to 'zeus' or 'bactobox'.")
endif



###############################################################################
### Firmware version
###############################################################################
.PHONY: set-version
set-version: FIRMWARE_VERSION_defined
	@# Replace in given file
	sed "s/{FIRMWARE_VERSION}/$$FIRMWARE_VERSION/g" \
	    include/configs/zynq_green_mango.h.in \
	    > /tmp/u-boot-set-version-output
	@# Only touch files if the checksum is different. This way,
	@# we avoid unnecessary rebuilds when make is called.
	rsync -c /tmp/u-boot-set-version-output include/configs/zynq_green_mango.h

.PHONY: FIRMWARE_VERSION_defined
FIRMWARE_VERSION_defined:
ifndef FIRMWARE_VERSION
	$(error "The 'FIRMWARE_VERSION' environment variable is not set.")
endif



###############################################################################
### U-boot environment
###############################################################################
u-boot-default-env.bin: u-boot-default-env.txt
	./tools/mkenvimage -s 65536 -o $@ $<

.PHONY: u-boot-default-env.txt
u-boot-default-env.txt:
	CROSS_COMPILE=$(CROSS_COMPILE) scripts/get_default_envs.sh > $@



###############################################################################
### Housekeeping
###############################################################################
.PHONY: clean
clean:
	$(UBOOT_MAKE) clean

.PHONY: mrproper
mrproper:
	$(UBOOT_MAKE) mrproper

.PHONY: distclean
distclean:
	$(UBOOT_MAKE) distclean
