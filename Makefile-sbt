PROCESSORS=$(shell grep -c ^processor /proc/cpuinfo)
CFLAGS="-O2 -mtune=cortex-a9 -mfpu=neon -mfloat-abi=hard"
CROSS_COMPILE?=arm-linux-gnueabihf-
UBOOT_MAKE=CROSS_COMPILE=$(CROSS_COMPILE) $(MAKE) -j $(PROCESSORS) \
	ARCH=arm CFLAGS=$(CFLAGS)



.PHONY: all
all: u-boot.elf



###############################################################################
### U-boot ELF file
###############################################################################
u-boot.elf: .config \
            common/* \
            configs/* \
            include/* \
            arch/arm/dts/*.dts \
            arch/arm/dts/*.dtsi
	$(UBOOT_MAKE)



###############################################################################
### Defconfig
###############################################################################
.config: TARGET_defined configs/zynq_green_mango_$(TARGET)_defconfig
	$(UBOOT_MAKE) zynq_green_mango_$(TARGET)_defconfig

.PHONY: TARGET_defined
TARGET_defined:
ifndef TARGET
	$(error "The 'TARGET' environment variable is not set. Set it to 'zeus' or 'bactobox'.")
endif



###############################################################################
### U-boot environment
###############################################################################
u-boot-default-env.bin: u-boot-default-env.txt
	./tools/mkenvimage -s 65536 -o $@ $<

.PHONY: u-boot-default-env.txt
u-boot-default-env.txt:
	CROSS_COMPILE=$(CROSS_COMPILE) scripts/get_default_envs.sh > $@



###############################################################################
### Housekeeping
###############################################################################
.PHONY: distclean
distclean:
	$(UBOOT_MAKE) distclean
