PROCESSORS=$(shell grep -c ^processor /proc/cpuinfo)
CFLAGS="-O2 -mtune=cortex-a9 -mfpu=neon -mfloat-abi=hard"
CROSS_COMPILE?=arm-linux-gnueabihf-
UBOOT_MAKE=CROSS_COMPILE=$(CROSS_COMPILE) $(MAKE) -j $(PROCESSORS) \
	ARCH=arm CFLAGS=$(CFLAGS)



.PHONY: all
all: zeus-u-boot.elf bactobox-u-boot.elf



###############################################################################
### U-boot ELF file
###############################################################################
# Common dependencies
zeus-u-boot.elf \
bactobox-u-boot.elf: set-version \
                     common/* \
                     configs/* \
                     include/* \
                     arch/arm/dts/*.dts \
                     arch/arm/dts/*.dtsi
zeus-u-boot.elf: .zeus-config
	KCONFIG_CONFIG=.zeus-config $(UBOOT_MAKE)
	cp -f u-boot.elf $@
bactobox-u-boot.elf: .bactobox-config
	KCONFIG_CONFIG=.bactobox-config $(UBOOT_MAKE)
	cp -f u-boot.elf $@



###############################################################################
### Defconfig
###############################################################################
.zeus-config: configs/zynq_green_mango_zeus_defconfig
	$(UBOOT_MAKE) zynq_green_mango_zeus_defconfig
	cp -f .config $@
.bactobox-config: configs/zynq_green_mango_bactobox_defconfig
	$(UBOOT_MAKE) zynq_green_mango_bactobox_defconfig
	cp -f .config $@



###############################################################################
### Firmware version
###############################################################################
.PHONY: set-version
set-version: FIRMWARE_VERSION_defined
	@# Replace in given file
	sed "s/{FIRMWARE_VERSION}/$$FIRMWARE_VERSION/g" \
	    include/configs/zynq_green_mango.h.in \
	    > /tmp/u-boot-set-version-output
	@# Only touch files if the checksum is different. This way,
	@# we avoid unnecessary rebuilds when make is called.
	rsync -c /tmp/u-boot-set-version-output include/configs/zynq_green_mango.h

.PHONY: FIRMWARE_VERSION_defined
FIRMWARE_VERSION_defined:
ifndef FIRMWARE_VERSION
	$(error "The 'FIRMWARE_VERSION' environment variable is not set.")
endif



###############################################################################
### U-boot environment
###############################################################################
zeus-u-boot-default-env.bin: zeus-u-boot-default-env.txt
bactobox-u-boot-default-env.bin: bactobox-u-boot-default-env.txt
zeus-u-boot-default-env.bin \
bactobox-u-boot-default-env.bin:
	./tools/mkenvimage -s 65536 -o $@ $<

zeus-u-boot-default-env.txt: zeus-u-boot.elf
bactobox-u-boot-default-env.txt: bactobox-u-boot.elf
.PHONY: zeus-u-boot-default-env.txt bactobox-u-bot-default-env.txt
zeus-u-boot-default-env.txt \
bactobox-u-boot-default-env.txt:
	CROSS_COMPILE=$(CROSS_COMPILE) scripts/get_default_envs.sh > $@



###############################################################################
### Housekeeping
###############################################################################
.PHONY: clean
clean:
	$(UBOOT_MAKE) clean
	rm -rf *.elf .*-config

.PHONY: mrproper
mrproper:
	$(UBOOT_MAKE) mrproper
	rm -rf *.elf .*-config

.PHONY: distclean
distclean:
	$(UBOOT_MAKE) distclean
	rm -rf *.elf .*-config
